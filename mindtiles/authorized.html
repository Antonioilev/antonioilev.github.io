<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Authorized</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    pre { background:#f0f0f0; padding:8px; }
    #debug{white-space:pre-wrap;}
  </style>
</head>
<body>
  <h2>Authorization result</h2>
  <div id="debug" style="display:block;"></div>
  <div id="actions"></div>

<script>
  const debugEl = document.getElementById('debug');
  function dbg(title, obj) {
    console.log(title, obj);
    debugEl.textContent += title + ' ' + (typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2)) + '\\n';
  }

  function parseFragment() {
    const hash = window.location.hash ? window.location.hash.substring(1) : '';
    dbg('Full fragment:', hash);
    const params = new URLSearchParams(hash);
    const out = {};
    for (const [k, v] of params.entries()) out[k] = v;
    return out;
  }

  (async function main(){
    const params = parseFragment();

    if (params.error) {
      dbg('Auth error', params);
      const actions = document.getElementById('actions');
      actions.innerHTML = '<p style="color:#a00">Link error: ' + (params.error_description || params.error) + '</p><button id="resend">Request new email</button>';
      document.getElementById('resend').onclick = () => {
        alert('Implement resend flow in your app or via Supabase admin.');
      };
      return;
    }

    if (!params.access_token) {
      dbg('No access_token found in fragment.');
      return;
    }

    // Show partial token for debug
    dbg('Access token (start):', params.access_token.slice(0, 30) + '...');

    // Try automatic POST to local Unity server
    const localUrl = 'http://localhost:8765/receive_token';
    const payload = {
      access_token: params.access_token,
      refresh_token: params.refresh_token || null,
      expires_at: params.expires_at || null,
      type: params.type || null
    };

    dbg('Attempting to POST token to local Unity endpoint: ' + localUrl);
    try {
      const resp = await fetch(localUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (resp.ok) {
        dbg('Successfully delivered token to Unity local endpoint.');
        document.getElementById('actions').innerHTML = '<p>Token sent to Unity (localhost).</p>';
      } else {
        dbg('Local endpoint responded with status: ' + resp.status);
        document.getElementById('actions').innerHTML = '<p>Local endpoint responded: ' + resp.status + '</p>';
        // show manual copy button
        showManual();
      }
    } catch (e) {
      dbg('Failed to POST to local endpoint (likely not running):', String(e));
      showManual();
    }

    function showManual() {
      const actions = document.getElementById('actions');
      actions.innerHTML = '<p>Automatic delivery failed. Copy token manually:</p>' +
        '<textarea id="tok" rows="6" cols="80">' + params.access_token + '</textarea><br/>' +
        '<button id="copy">Copy token</button>';
      document.getElementById('copy').onclick = () => {
        const ta = document.getElementById('tok');
        ta.select();
        document.execCommand('copy');
        alert('Token copied to clipboard');
      };
    }

  })();
</script>
</body>
</html>
