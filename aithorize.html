<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Authorized — MindTiles</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; color:#111 }
    .ok { color: green; }
    .err { color: red; }
    .card { border:1px solid #ddd; padding:16px; border-radius:8px; max-width:720px; margin:auto }
    button { padding:8px 12px; margin-top:12px; }
    pre { background:#f7f7f7; padding:8px; overflow:auto }
  </style>
</head>
<body>
  <div class="card">
    <h2>Авторизация</h2>
    <div id="status">Обработка токена...</div>
    <div id="actions" style="margin-top:12px;"></div>
    <div id="tokenBox" style="margin-top:12px; display:none;">
      <label>Токен (скопируйте вручную если нужно):</label>
      <pre id="rawToken" style="white-space:normal; word-break:break-all"></pre>
      <button id="copyBtn">Скопировать в буфер</button>
    </div>
  </div>

  <script>
    (async function(){
      const VERIFY_URL = 'https://jkogvwoghymvypwzzcco.functions.supabase.co/verify-token'; // <-- замените если нужно
      const DEEPLINK_SCHEME = 'mygame://auth'; // <-- замените на вашу схему, например mindtiles://auth

      const statusEl = document.getElementById('status');
      const actionsEl = document.getElementById('actions');
      const tokenBox = document.getElementById('tokenBox');
      const rawTokenEl = document.getElementById('rawToken');
      const copyBtn = document.getElementById('copyBtn');

      function getFragmentToken() {
        // URL вида ...#access_token=...&expires_in=...
        const hash = window.location.hash || '';
        if (!hash) return null;
        const params = new URLSearchParams(hash.replace(/^#/, ''));
        return params.get('access_token') || null;
      }

      function showError(msg) {
        statusEl.innerHTML = '<span class="err">Ошибка: ' + msg + '</span>';
      }

      function showOK(msg) {
        statusEl.innerHTML = '<span class="ok">' + msg + '</span>';
      }

      const token = getFragmentToken();
      if (!token) {
        showError('Токен не найден в URL. Убедитесь, что вы попали на эту страницу после авторизации.');
        actionsEl.innerHTML = '<button onclick="location.reload()">Попробовать снова</button>';
        return;
      }

      rawTokenEl.textContent = token;
      tokenBox.style.display = 'block';

      // Попытка верифицировать токен через Edge Function
      try {
        showOK('Проверяем токен на сервере...');
        const resp = await fetch(VERIFY_URL, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token }) // body не обязателен, auth header достаточен
        });

        const data = await resp.json().catch(()=>null);
        if (!resp.ok || !data || data.ok !== true) {
          // Если верификация не прошла — показываем ошибку и даём manual copy/deeplink
          showError('Верификация токена не удалась. Сервер вернул ошибку.');
          actionsEl.innerHTML = `
            <div>Ответ сервера: <pre style="white-space:pre-wrap">${JSON.stringify(data)}</pre></div>
            <button id="openDl">Открыть deeplink вручную</button>
          `;
          document.getElementById('openDl').onclick = () => {
            // open deeplink even if server verification failed
            location.href = DEEPLINK_SCHEME + '#access_token=' + encodeURIComponent(token);
          };
          return;
        }

        // Успех верификации — открываем deeplink, но даём fallback кнопку
        showOK('Токен валиден. Открываем приложение...');
        actionsEl.innerHTML = `
          <div>Пользователь: <strong>${(data.user && (data.user.email || data.user.id)) || 'unknown'}</strong></div>
          <button id="openDl">Открыть приложение</button>
          <button id="fallback">Если не открылось — показать токен</button>
        `;
        const openDlBtn = document.getElementById('openDl');
        openDlBtn.onclick = () => {
          // Пытаемся навигацией открыть deeplink
          location.href = DEEPLINK_SCHEME + '#access_token=' + encodeURIComponent(token);
          // Также ставим короткую задержку и показываем инструкцию
          setTimeout(()=> {
            document.getElementById('fallback').style.display = 'inline-block';
          }, 1200);
        };
        document.getElementById('fallback').onclick = () => {
          tokenBox.style.display = 'block';
        };

      } catch (e) {
        showError('Ошибка при вызове verify-token: ' + e.message);
        actionsEl.innerHTML = '<button onclick="location.reload()">Попробовать снова</button>';
      }

      // copy button
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(rawTokenEl.textContent);
          copyBtn.textContent = 'Скопировано';
          setTimeout(()=> copyBtn.textContent = 'Скопировать в буфер', 1500);
        } catch(err) {
          copyBtn.textContent = 'Копирование не поддерживается';
        }
      });

    })();
  </script>
</body>
</html>